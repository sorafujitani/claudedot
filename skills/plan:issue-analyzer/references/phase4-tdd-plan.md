# Phase 4: TDD Implementation Plan（TDD実装計画の作成）

## 目的

Phase 3 で選定したアプローチを、t-wada の TDD 理論に基づく具体的な実装計画に落とし込む。
計画は `.claude/plans/` にマークダウンファイルとして保存する。

## t-wada TDD 理論

### Red-Green-Refactor サイクル

```
Red    → 失敗するテストを書く（テストが失敗することを確認）
Green  → テストを通す最小限のコードを書く
Refactor → テストが通る状態を保ちながら、コードを改善する
```

### TDD の3原則

1. **失敗するテストを書くまで、プロダクションコードを書かない**
2. **失敗するテストは1つだけ書く**（最小単位）
3. **テストを通すために最小限のコードだけ書く**

### 計画への適用

修正全体を小さな TDD サイクルに分解する:
- 各サイクルは独立して実行・検証可能
- 前のサイクルの成果を壊さない
- 1サイクル = 1つのテスト + 1つの修正

## サブエージェント戦略

`Task(Explore)` x1 で以下を確認:
- テストファイルの命名規則と配置場所
- テストヘルパーとフィクスチャの利用可能性
- テスト実行コマンドと CI 設定
- コミットメッセージの規約

## 計画出力

### ファイル名

`.claude/plans/issue-analyzer-{YYYY-MM-DD}-{short-description}.md`

例: `.claude/plans/issue-analyzer-2026-02-22-fix-parser-escape-handling.md`

### 出力テンプレート

```markdown
# TDD実装計画: {Issue タイトル}

## メタ情報
- **Issue**: [{タイトル}]({URL})
- **リポジトリ**: {owner/repo}
- **選定アプローチ**: {Phase 3 で選んだアプローチ名と概要}
- **作成日**: {YYYY-MM-DD}
- **推定サイクル数**: {N}

## 前提条件
- [ ] リポジトリのクローン・セットアップ完了
- [ ] テスト実行環境の準備完了（{テストフレームワーク名}）
- [ ] 既存テストが全て通ることを確認: `{テスト実行コマンド}`
- [ ] 作業ブランチ作成: `git checkout -b fix/{短い説明}`

## TDDサイクル一覧

### サイクル 1: {最小の検証単位の説明}

**Red（失敗するテストを書く）**:

テストファイル: `{テストファイルパス}`

テスト内容:
- テスト名: `{テスト名}`
- 入力: {入力の説明}
- 期待値: {期待される結果}
- 現状: このテストは FAIL する（{理由}）

実行と確認:
```bash
{テスト実行コマンド}
```
期待される失敗メッセージ: {どのようなエラーが出るか}

**Green（最小限のコードを書く）**:

修正箇所: `{ファイルパス}` の `{関数/メソッド名}`
修正概要: {何をどう変えるか、自然言語で説明}
注意: 最小限の変更に留めること。リファクタリングはこの段階では行わない。

実行と確認:
```bash
{テスト実行コマンド}
```
全テストが PASS することを確認。

**Refactor（コードの改善）**:

{リファクタリングの候補があれば記載。なければ「このサイクルでは不要」}
リファクタリング後も全テストが PASS することを確認。

コミット:
```bash
git add {変更ファイル}
git commit -m "{コミットメッセージ}"
```

---

### サイクル 2: {次の検証単位}
[同様の形式]

---

### サイクル N: {最終検証}
[同様の形式]

## 最終検証

### 全テスト実行
```bash
{全テスト実行コマンド}
```

### 手動検証
1. {Issue の再現手順を実行し、問題が解消されていることを確認}
2. {エッジケースの確認}

### リグレッション確認
- {既存機能への影響がないことの確認方法}

## PR作成前チェックリスト
- [ ] 全テストがパスする
- [ ] 新規テストが追加されている
- [ ] コーディング規約に準拠（lint, format）
- [ ] CHANGELOG 更新（必要な場合）
- [ ] ドキュメント更新（API変更がある場合）
- [ ] コミットメッセージがプロジェクト規約に準拠
- [ ] PR の説明文に Issue 番号を参照
```

## 計画作成のガイドライン

### サイクル分解の基準

- 1サイクルで扱う変更は1つの論理的な単位
- テストと修正が 1:1 対応
- 各サイクル完了後に全テストが通る状態を維持
- サイクルの順序は依存関係に基づく（基盤 → 応用）

### テスト基盤がないプロジェクトの場合

サイクル 0 としてテスト環境セットアップを含める:
- テストフレームワークのインストール
- テスト設定ファイルの作成
- 最初のテストファイル作成と実行確認

### 修正が1行の単純な場合

単一サイクルの計画でも構わない。計画の価値はドキュメンテーションと検証手順にある。

## 確認ゲート

1. 計画全体をユーザーに提示
2. 以下を確認:
   - サイクルの粒度は適切か
   - テストケースの網羅性は十分か
   - 実装順序に問題はないか
   - 追加すべきエッジケースはあるか
3. ユーザーの承認後、`.claude/plans/` にファイルを保存
4. 進捗チェックリストの Phase 4 を完了にして、全体完了を表示
