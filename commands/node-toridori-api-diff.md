---
description: Node.js/TypeScript APIに特化したgit diffレビュー（トランザクション・型定義・非同期処理を重点チェック）
allowed-tools: Bash(git diff:*), Bash(git status:*), Bash(git log:*), Grep, Read
---

現在のgit diffの内容に対して、Node.js/TypeScript APIに特化したコードレビューを実行してください：

まず、以下のコマンドを実行して変更内容と関連コンテキストを確認してください：
1. `git status` - 変更されたファイルの一覧を確認
2. `git diff` - 変更内容の詳細を確認
3. `git log -5 --oneline` - 最近のコミット履歴を確認
4. 変更された関数について、その関数全体のコードと周辺のコンテキストを`Read`ツールで確認

## レビュー観点

### 1. Node.js/TypeScriptのベストプラクティス
- TopType, ButtonTypeの使用はプラクティスに沿った理由がないければ使用しない（unknown、any など）
  - noExplicitAnyの考慮
- エラーハンドリングの適切性
- Node.js固有のパフォーマンス考慮
- EcmaScriptの最新仕様が活用されている

### 2. 型定義の完全性
- 引数・戻り値の型定義の妥当性
- enum、bigint、union型など、プロジェクト特性に応じた型の使用
- ジェネリクスの適切な活用
- 型推論に頼りすぎない明示的な型定義
- falsty, nullishなどの考慮

### 3. データベーストランザクション管理
- トランザクションの適切な開始・コミット・ロールバック
- 複数トランザクション間のデータ整合性, 連続リクエストを考慮した排他ロックが適切に使用されているか
- トランザクション内での責務分離
- デッドロック回避の考慮
- 排他ロック（FOR UPDATE）の適切な使用
- 同時実行制御とリソース整合性の確保

### 4. 非同期処理とエラーハンドリング
- Promise処理の正確性
  - async/awaitの適切な使用
  - Unhandled Promise Rejectionのリスク
  - 非同期処理の解決漏れを確実に指摘する。noFloatingPromisesなどの観点
- try-catchブロックの適切な配置
- 非同期関数のエラー伝播
- I/Oが返却するエラーの例外制御

### 5. パフォーマンスと効率性
- N+1クエリ問題の回避
  - GraphQLである場合は、DataLoaderの使用もしくはResolver解決のBatch化
- 可能な範囲での並列処理を要求します。Promiseの機能などを用いて非同期関数の直列実行 or 並列実行を評価してください
- メモリリークのリスク
- 計算量の最適化
- より簡潔で効率的なイディオムの提案
- テストすべきビジネスロジックを純粋関数に切り出せるかの検討
  - プリミティブな値をparameterに取るだけで単体テスト可能であるかどうか
### 6. 命名とコード構造
- 変数・関数名の明確性と一貫性
- ファイル・モジュール構成の適切性
- 関数の責務の単一性
- コメントの必要性（複雑なロジックの説明）
- 重複した状態や定数の定義を抽象化

### 7. セキュリティ考慮事項
- SQLインジェクション対策
- 入力値検証の完全性
- 認証・認可の適切な実装
- センシティブ情報の取り扱い
- レート制限の必要性

### 8. schema.prismaの変更
- Prismaスキーマの変更内容の妥当性
- キャメルケースに変更したfieldに適切に@mapが使用されているか
- formatが正しく行われているか
- リレーションとそれに伴う命名が設定されているか

### 9. テストとドキュメント
- テストケースの追加・更新の必要性
- エッジケースのカバー
- APIドキュメントの更新必要性
- 変更に伴う環境変数の追加

## レビュー結果の形式

以下の形式でレビュー結果を提供してください：

### 🚨 重大な問題
- 実行時エラーやデータ不整合を引き起こす可能性のある問題

### ⚠️ 要改善点
- 将来的な問題やパフォーマンス低下につながる可能性のある箇所

### 💡 推奨事項
- より良い実装方法やベストプラクティスの提案

各項目について、具体的なコード行番号と改善案を提示してください。
